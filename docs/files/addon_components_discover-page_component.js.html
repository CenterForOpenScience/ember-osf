<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>addon/components/discover-page/component.js - Ember OSF Addon</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="https://cdn.cos.io/static/images/cos_wide.png" title="Ember OSF Addon"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.19.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ajax-helpers.html">ajax-helpers</a></li>
                                <li><a href="../classes/Analytics.html">Analytics</a></li>
                                <li><a href="../classes/auth.html">auth</a></li>
                                <li><a href="../classes/author-link.html">author-link</a></li>
                                <li><a href="../classes/buildSecondaryNavLinks.html">buildSecondaryNavLinks</a></li>
                                <li><a href="../classes/CasAuthenticatedRouteMixin.html">CasAuthenticatedRouteMixin</a></li>
                                <li><a href="../classes/Citation.html">Citation</a></li>
                                <li><a href="../classes/citation-widget.html">citation-widget</a></li>
                                <li><a href="../classes/Collection.html">Collection</a></li>
                                <li><a href="../classes/Comment.html">Comment</a></li>
                                <li><a href="../classes/comment-detail.html">comment-detail</a></li>
                                <li><a href="../classes/comment-form.html">comment-form</a></li>
                                <li><a href="../classes/comment-pane.html">comment-pane</a></li>
                                <li><a href="../classes/CommentableMixin.html">CommentableMixin</a></li>
                                <li><a href="../classes/CommentReport.html">CommentReport</a></li>
                                <li><a href="../classes/Contributor.html">Contributor</a></li>
                                <li><a href="../classes/current-user.html">current-user</a></li>
                                <li><a href="../classes/discover-page.html">discover-page</a></li>
                                <li><a href="../classes/DraftRegistration.html">DraftRegistration</a></li>
                                <li><a href="../classes/dropzone-widget.html">dropzone-widget</a></li>
                                <li><a href="../classes/elem-id.html">elem-id</a></li>
                                <li><a href="../classes/eosf-project-nav.html">eosf-project-nav</a></li>
                                <li><a href="../classes/faceted-search.html">faceted-search</a></li>
                                <li><a href="../classes/File.html">File</a></li>
                                <li><a href="../classes/file-browser.html">file-browser</a></li>
                                <li><a href="../classes/file-browser-icon.html">file-browser-icon</a></li>
                                <li><a href="../classes/file-chooser component.html">file-chooser component</a></li>
                                <li><a href="../classes/file-editor.html">file-editor</a></li>
                                <li><a href="../classes/file-manager.html">file-manager</a></li>
                                <li><a href="../classes/file-renderer.html">file-renderer</a></li>
                                <li><a href="../classes/file-version.html">file-version</a></li>
                                <li><a href="../classes/file-widget.html">file-widget</a></li>
                                <li><a href="../classes/FileCacheBypassMixin.html">FileCacheBypassMixin</a></li>
                                <li><a href="../classes/FileItemMixin.html">FileItemMixin</a></li>
                                <li><a href="../classes/FileProvider.html">FileProvider</a></li>
                                <li><a href="../classes/FileVersion.html">FileVersion</a></li>
                                <li><a href="../classes/filterReplace.html">filterReplace</a></li>
                                <li><a href="../classes/fix-special-char.html">fix-special-char</a></li>
                                <li><a href="../classes/fix-special-char-helper.html">fix-special-char-helper</a></li>
                                <li><a href="../classes/fixstring.html">fixstring</a></li>
                                <li><a href="../classes/GenericDataADapter.html">GenericDataADapter</a></li>
                                <li><a href="../classes/getDisplayName.html">getDisplayName</a></li>
                                <li><a href="../classes/HostAppNameMixin.html">HostAppNameMixin</a></li>
                                <li><a href="../classes/human-file-size.html">human-file-size</a></li>
                                <li><a href="../classes/ifFilter.html">ifFilter</a></li>
                                <li><a href="../classes/InfinityCustomMixin.html">InfinityCustomMixin</a></li>
                                <li><a href="../classes/Institution.html">Institution</a></li>
                                <li><a href="../classes/license-picker.html">license-picker</a></li>
                                <li><a href="../classes/Log.html">Log</a></li>
                                <li><a href="../classes/Metaschema.html">Metaschema</a></li>
                                <li><a href="../classes/mimeTypes.html">mimeTypes</a></li>
                                <li><a href="../classes/navbar-auth-dropdown.html">navbar-auth-dropdown</a></li>
                                <li><a href="../classes/new-navbar-auth-dropdown.html">new-navbar-auth-dropdown</a></li>
                                <li><a href="../classes/Node.html">Node</a></li>
                                <li><a href="../classes/NodeActionsMixin.html">NodeActionsMixin</a></li>
                                <li><a href="../classes/NodeLink.html">NodeLink</a></li>
                                <li><a href="../classes/oauth-popup.html">oauth-popup</a></li>
                                <li><a href="../classes/old-file-browser.html">old-file-browser</a></li>
                                <li><a href="../classes/osf-copyright.html">osf-copyright</a></li>
                                <li><a href="../classes/osf-footer.html">osf-footer</a></li>
                                <li><a href="../classes/osf-mode-footer.html">osf-mode-footer</a></li>
                                <li><a href="../classes/osf-navbar.html">osf-navbar</a></li>
                                <li><a href="../classes/osf-paginator.html">osf-paginator</a></li>
                                <li><a href="../classes/osf-services.html">osf-services</a></li>
                                <li><a href="../classes/OsfAdapter.html">OsfAdapter</a></li>
                                <li><a href="../classes/OsfAgnosticAuthController.html">OsfAgnosticAuthController</a></li>
                                <li><a href="../classes/OsfAgnosticAuthRoute.html">OsfAgnosticAuthRoute</a></li>
                                <li><a href="../classes/OsfCookieAuthenticator.html">OsfCookieAuthenticator</a></li>
                                <li><a href="../classes/OsfCookieAuthorizer.html">OsfCookieAuthorizer</a></li>
                                <li><a href="../classes/OsfCookieLoginController.html">OsfCookieLoginController</a></li>
                                <li><a href="../classes/OsfCookieLoginRoute.html">OsfCookieLoginRoute</a></li>
                                <li><a href="../classes/OsfModel.html">OsfModel</a></li>
                                <li><a href="../classes/OsfSerializer.html">OsfSerializer</a></li>
                                <li><a href="../classes/OsfTokenAuthenticator.html">OsfTokenAuthenticator</a></li>
                                <li><a href="../classes/OsfTokenAuthorizer.html">OsfTokenAuthorizer</a></li>
                                <li><a href="../classes/OsfTokenLoginControllerMixin.html">OsfTokenLoginControllerMixin</a></li>
                                <li><a href="../classes/OsfTokenLoginRouteMixin.html">OsfTokenLoginRouteMixin</a></li>
                                <li><a href="../classes/outside-click.html">outside-click</a></li>
                                <li><a href="../classes/PaginatedControllerMixin.html">PaginatedControllerMixin</a></li>
                                <li><a href="../classes/PaginatedRouteMixin.html">PaginatedRouteMixin</a></li>
                                <li><a href="../classes/pagination-control.html">pagination-control</a></li>
                                <li><a href="../classes/permissions.html">permissions</a></li>
                                <li><a href="../classes/Preprint.html">Preprint</a></li>
                                <li><a href="../classes/project-selector.html">project-selector</a></li>
                                <li><a href="../classes/providerRegex.html">providerRegex</a></li>
                                <li><a href="../classes/Registration.html">Registration</a></li>
                                <li><a href="../classes/RegistrationActionsMixin.html">RegistrationActionsMixin</a></li>
                                <li><a href="../classes/scheduled-banner.html">scheduled-banner</a></li>
                                <li><a href="../classes/search-dropdown.html">search-dropdown</a></li>
                                <li><a href="../classes/search-facet-locked.html">search-facet-locked</a></li>
                                <li><a href="../classes/search-help-modal.html">search-help-modal</a></li>
                                <li><a href="../classes/search-result.html">search-result</a></li>
                                <li><a href="../classes/service-links.html">service-links</a></li>
                                <li><a href="../classes/sign-up.html">sign-up</a></li>
                                <li><a href="../classes/sortOptionDisplay.html">sortOptionDisplay</a></li>
                                <li><a href="../classes/Subscription.html">Subscription</a></li>
                                <li><a href="../classes/TaggableMixin.html">TaggableMixin</a></li>
                                <li><a href="../classes/tags-widget.html">tags-widget</a></li>
                                <li><a href="../classes/Taxonomy.html">Taxonomy</a></li>
                                <li><a href="../classes/theme.html">theme</a></li>
                                <li><a href="../classes/total-share-results.html">total-share-results</a></li>
                                <li><a href="../classes/User.html">User</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/adapters.html">adapters</a></li>
                                <li><a href="../modules/authenticators.html">authenticators</a></li>
                                <li><a href="../modules/authorizers.html">authorizers</a></li>
                                <li><a href="../modules/components.html">components</a></li>
                                <li><a href="../modules/const.html">const</a></li>
                                <li><a href="../modules/ember-osf.html">ember-osf</a></li>
                                <li><a href="../modules/helpers.html">helpers</a></li>
                                <li><a href="../modules/mixins.html">mixins</a></li>
                                <li><a href="../modules/models.html">models</a></li>
                                <li><a href="../modules/serializers.html">serializers</a></li>
                                <li><a href="../modules/services.html">services</a></li>
                                <li><a href="../modules/transforms.html">transforms</a></li>
                                <li><a href="../modules/utils.html">utils</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: addon/components/discover-page/component.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import Ember from &#x27;ember&#x27;;
import layout from &#x27;./template&#x27;;

import config from &#x27;ember-get-config&#x27;;
import { task } from &#x27;ember-concurrency&#x27;;

import Analytics from &#x27;../../mixins/analytics&#x27;;
import hostAppName from &#x27;../../mixins/host-app-name&#x27;;

/**
 * @module ember-osf
 * @submodule components
 */

/**
 *  Discover-page component. Builds a search interface utilizing SHARE.
 *  See retraction-watch, registries, and preprints discover pages for working examples.
 *
 *  Majority adapted from Ember-SHARE https://github.com/CenterForOpenScience/ember-share, with additions from PREPRINTS
 *  and REGISTRIES discover pages. Original Ember-SHARE facets and PREPRINTS/REGISTRIES facets behave differently at this time.
 *  You can build a discover-page that uses Ember-SHARE type facets -OR- PREPRINTS/REGISTRIES type facets.  Would not recommend
 *  mixing until code is combined.
 *
 *  How to Use:
 *  Pass in custom text like searchPlaceholder.  The facets property will enable you to customize the filters
 *  on the left-hand side of the discover page. Sort options are the sort dropdown options. Each query parameter must be passed in individually,
 *  so they are reflected in the URL.  Logo and custom colors must be placed in the consuming application&#x27;s stylesheet. Individual components
 *  can additionally be overridden in your application.
 *
 * Sample usage:
 * &#x60;&#x60;&#x60;handlebars
 *{{discover-page
 *    consumingService=consumingService
 *    searchPlaceholder=searchPlaceholder
 *    detailRoute=detailRoute
 *    discoverHeader=discoverHeader
 *    themeProvider=themeProvider
 *
 *    sortOptions=sortOptions
 *    filterReplace=filterReplace
 *    whiteListedProviders=whiteListedProviders
 *    fetchedProviders=externalProviders
 *
 *    facets=facets
 *    results=results
 *    numberOfResults=numberOfResults
 *    aggregations=aggregations
 *    queryParamsState=queryParamsState
 *
 *    showActiveFilters=showActiveFilters
 *    loading=fetchData.isRunning
 *
 *    clearFilters=(action &#x27;clearFilters&#x27;)
 *    search=(action &#x27;search&#x27;)
 *
 *    size=size
 *    page=page
 *    q=q
 *    sort=sort
 * }}
 * {{!-- plus any query params (e.g. provider=provider) --}}
 * &#x60;&#x60;&#x60;
 * @class discover-page
 */

const MAX_SOURCES = 500;

export default Ember.Component.extend(Analytics, hostAppName, {
    layout,
    currentUser: Ember.inject.service(&#x27;current-user&#x27;),
    theme: Ember.inject.service(),
    i18n: Ember.inject.service(),

    classNames: [&#x27;discover-page&#x27;],

    // ************************************************************
    // PROPERTIES
    // ************************************************************

    /**
     * Size query parameter.  If &quot;size&quot; is one of your query params, it must be passed to the component so it can be updated.
     * @property {Integer} size
     * @default 10
     */
    size: 10,

    /**
     * Sort query parameter.  If &quot;sort&quot; is one of your query params, it must be passed to the component so it can be updated.
     * @property {String} sort
     * @default &#x27;&#x27;
     */
    sort: &#x27;&#x27;,

    /**
     * Page query parameter.  If &quot;page&quot; is one of your query params, it must be passed to the component so it can be updated.
     * @property {Integer} page
     * @default 1
     */
    page: 1,

    /**
     * q query parameter.  If &quot;q&quot; is one of your query params, it must be passed to the component so it can be updated.
     * @property {String} q
     * @default &#x27;&#x27;
     */
    q: &#x27;&#x27;,

    /**
     * Name of detail route for consuming application, like &quot;content&quot; or &quot;detail&quot;. Override if search result title should link to detail route.
     * @property {String} detailRoute
     */
    detailRoute: null,

    /**
     * Text header for top of discover page.
     * @property {String} discoverHeader
     */
    discoverHeader: null,


    /**
     * For PREPRINTS ONLY.  Pass in the providers fetched in preprints app so they can be used in the provider carousel
     * @property {Object} fetchedProviders
     */
    fetchedProviders: null,

    /**
     * For PREPRINTS and REGISTRIES. A mapping of filter names for front-end display. Ex. {OSF: &#x27;OSF Preprints&#x27;}.
     * @property {Object} filterReplace
     */
    filterReplace: {},

    /**
     * For PREPRINTS and REGISTRIES.  Displays activeFilters box above search facets.
     * @property {boolean} showActiveFilters
     */
    showActiveFilters: false,

    showLuceneHelp: false,

    numberOfResults: 0,
    numberOfSources: 0,

    results: Ember.ArrayProxy.create({ content: [] }), // Results from SHARE query

    /**
     * Sort dropdown options - Array of dictionaries.  Each dictionary should have display and sortBy keys.
     * @property {Array} sortOptions
     * @default [{
        display: &#x27;Relevance&#x27;,
        sortBy: &#x27;&#x27;
       }]
     */
    sortOptions: [{
        display: &#x27;Relevance&#x27;,
        sortBy: &#x27;&#x27;
    }, {
        display: &#x27;Date Updated (Desc)&#x27;,
        sortBy: &#x27;-date_updated&#x27;
    }, {
        display: &#x27;Date Updated (Asc)&#x27;,
        sortBy: &#x27;date_updated&#x27;
    }, {
        display: &#x27;Ingest Date (Asc)&#x27;,
        sortBy: &#x27;date_created&#x27;
    }, {
        display: &#x27;Ingest Date (Desc)&#x27;,
        sortBy: &#x27;-date_created&#x27;
    }],

    /**
     * themeProvider
     * @property {Object} Preprint provider loaded from theme service. Should be passed from consuming service so it is loaded before SHARE is queried.
     * @default &#x27;&#x27;
     */
    themeProvider: null,


    // ************************************************************
    // COMPUTED PROPERTIES
    // ************************************************************

    domainRedirectProviders: Ember.computed(function() {
        let providerDomains = [];
        let providers = this.get(&#x27;fetchedProviders&#x27;);
        for (let providerVal of providers) {
            if (providerVal.get(&#x27;domain&#x27;) &amp;&amp; providerVal.get(&#x27;domainRedirectEnabled&#x27;) === true) {
                providerDomains.push(providerVal.get(&#x27;domain&#x27;));
            }
        }
        return providerDomains;
    }),

    clampedPages: Ember.computed(&#x27;totalPages&#x27;, &#x27;size&#x27;, function() {
        // requesting over 10000 will error due to elastic limitations
        // https://www.elastic.co/guide/en/elasticsearch/guide/current/pagination.html
        let maxPages = Math.ceil(10000 / this.get(&#x27;size&#x27;));
        let totalPages = this.get(&#x27;totalPages&#x27;);

        return totalPages &lt; maxPages ? totalPages : maxPages;
    }),

    totalPages: Ember.computed(&#x27;numberOfResults&#x27;, &#x27;size&#x27;, function() {
        // Total pages of search results
        return Math.ceil(this.get(&#x27;numberOfResults&#x27;) / this.get(&#x27;size&#x27;));
    }),

    actions: {
        clearFilters() {
            this.get(&#x27;metrics&#x27;).trackEvent({
                category: &#x27;button&#x27;,
                action: &#x27;click&#x27;,
                label: &#x27;Discover - Clear Filters&#x27;,
            });

            this.get(&#x27;clearFilters&#x27;)();
        },

        search() {
            this.get(&#x27;metrics&#x27;).trackEvent({
                category: &#x27;button&#x27;,
                action: &#x27;click&#x27;,
                label: &#x27;Discover - Search&#x27;,
                extra: this.get(&#x27;q&#x27;),
            });

            this.get(&#x27;search&#x27;)();
        },

        selectSortOption(option) {
            // Runs when sort option changed in dropdown
            this.get(&#x27;metrics&#x27;).trackEvent({
                category: &#x27;dropdown&#x27;,
                action: &#x27;select&#x27;,
                label: &#x60;Sort by: ${option || &#x27;relevance&#x27;}&#x60;
            });

            this.set(&#x27;sort&#x27;, option);
        },

        selectPage(pageNumber) {
            // When paginating, sets page and scrolls to top of results.
            this.set(&#x27;page&#x27;, pageNumber);
            if (scroll) {
                this.scrollToResults();
            }
        },

        toggleShowLuceneHelp() {
            this.toggleProperty(&#x27;showLuceneHelp&#x27;);
        },

        updateFilters(filterType, item) {
            item = typeof item === &#x27;object&#x27; ? item.text : item;
            const currentState = this.get(&#x60;queryParamsState.${filterType}.value&#x60;).slice(0);
            const hasItem = currentState.includes(item);

            if (hasItem) {
                this.set(filterType, currentState.filter(x =&gt; !item.includes(x)));
            } else {
                currentState.pushObject(item)
                this.set(filterType, currentState);
            }

            this.get(&#x27;metrics&#x27;).trackEvent({
                category: &#x27;filter&#x27;,
                action: hasItem ? &#x27;remove&#x27; : &#x27;add&#x27;,
                label: &#x60;Discover - ${filterType} ${item}&#x60;
            });
        },

        updateParams(key, value) {
            this.set(key, value);
        },
    },

    // ************************************************************
    // Discover-page METHODS and HOOKS
    // ************************************************************

    scrollToResults() {
        // Scrolls to top of search results
        Ember.$(&#x27;html, body&#x27;).scrollTop(this.$(&#x27;.results-top&#x27;).position().top);
    },

    isTypeFacet(obj) {
        return obj.key === &#x27;type&#x27;;
    },

    getTypes: task(function* () {
        const response = yield Ember.$.ajax({
            url: &#x60;${config.OSF.shareApiUrl}/schema/creativework/hierarchy/&#x60;,
            crossDomain: true,
            type: &#x27;GET&#x27;,
            contentType: &#x27;application/vnd.api+json&#x27;,
        });
        if (response.data) {
            const types = response.data.CreativeWork ? response.data.CreativeWork.children : {};
            this.get(&#x27;facets&#x27;).find(this.isTypeFacet).data = this.transformTypes(types);
        }
    }),

    transformTypes(types) {
        const tmpTypes = types;
        if (typeof (tmpTypes) !== &#x27;object&#x27;) {
            return tmpTypes;
        }

        for (const key of Object.keys(tmpTypes)) {
            const lowKey = key.replace(/([A-Z])/g, &#x27; $1&#x27;).trim().toLowerCase();
            tmpTypes[lowKey] = this.transformTypes(tmpTypes[key]);
            if (key !== lowKey) {
                delete tmpTypes[key];
            }
        }

        return tmpTypes;
    },

    getCounts: task(function* () {
        const searchUrl = &#x60;${config.OSF.shareSearchUrl}?preference=${this.get(&#x27;currentUser.sessionKey&#x27;)}&#x60;;
        const queryBody = JSON.stringify({
            size: 0,
            aggregations: {
                sources: {
                    cardinality: {
                        field: &#x27;sources&#x27;,
                        precision_threshold: MAX_SOURCES,
                    },
                },
            },
        });
        const response = yield Ember.$.ajax({
            url: searchUrl,
            crossDomain: true,
            type: &#x27;POST&#x27;,
            contentType: &#x27;application/json&#x27;,
            data: queryBody,
        });
        this.setProperties({
            numberOfEvents: response.hits.total,
            numberOfSources: response.aggregations.sources.value,
        });
    }),

    init() {
        // TODO Sort initial results on date_modified
        // Runs on initial render.
        this._super(...arguments);

        this.get(&#x27;getTypes&#x27;).perform();
        this.get(&#x27;getCounts&#x27;).perform();
    },
});

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
